---
title: "Intro to Tidyverse"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)
library(learnr)
library(lubridate)
knitr::opts_chunk$set(echo = FALSE)

deaths <- read_csv("data/chj_mn_opiate_deaths_data.csv") %>% clean_names()

deaths_clean <- deaths %>% 
  mutate(
    birth_clean_date = birth_date %>% mdy(),
    death_clean_date = death_date %>% mdy(),
    injury_clean_date = injury_date %>% mdy(),
  )

```

## Our goals for this section

About 80% of data journalism consists of these basic data concepts:

- Selecting columns
- Filtering rows
- Sorting results
- Calculating new data
- Summarizing

(When you have time, you can find a [series of videos](https://vimeo.com/showcase/7320305) that explain some of these basic concepts.)

We'll do all that here in day 2, mostly using functions from the [dplyr](https://dplyr.tidyverse.org/) package from the tidyverse.

This day will work a little differently than Day 1. We'll first cover all the concepts in the tutorial, then you'll practice on your own with data you started yesterday.

### About the tutorial data

We never really discussed the tutorial data we were using in Day 1, but it is opioid-related deaths in Minnesota over a 12-year period. We'll continue with that today.

## Select columns

The [`select()`](https://dplyr.tidyverse.org/reference/select.html) function allows you to select or exclude **columns** from your data. (You may also see columns noted as "variables".)

To demonstrate how it works, we'll use deaths data, which has 33 columns. Let's review them.

```{r deaths-glimpse, exercise = T, exercise.eval = T}
deaths %>% glimpse()
```

### Select by naming columns

If we want to focus on just the demographics  of the subjects in our data, we can just name the columns we want. We use `head()` here just to limit the output.

```{r deaths-select, exercise=T, exercise.eval=T}
# select columns in deaths
deaths %>% 
  select(first_name, last_name, gender, race) %>% 
  head()
```

To be clear, we haven't changed the underlying data in `deaths` ... we are just printing this to the screen. If we wanted to save this selection, we would need to assign it to a new R object.

### Selection helpers

The example above was pretty simple, but there are [other selection helpers](https://dplyr.tidyverse.org/reference/select.html) you can use within `select()`. Guess what the next code block will do and then run it.

```{r deaths-select-endswith, exercise=T}
deaths %>% 
  select(first_name, last_name, ends_with("_date")) %>% 
  head()
```

### Select on your own

There is a selection helper `starts_with()` just like there `ends_with()`. 

1. Use both `starts_with()` and `ends_with()` to edit the select below to capture "name" related columns and the "injury" related columns from the deaths data. You might review the column names in the glimpse above.

```{r deaths-select-test, exercise=T}
deaths

```

<div id="deaths-select-test-hint">
```r
deaths %>% 
  select(ends_with("name"), suffix, starts_with("injury"))
```
</div>

### Removing columns

Sometimes is it easier to remove a column than it is to specify all the rest, and you can do that by adding `-` before the selection, be that a column name, selection helper or `c()` combination.

1. Remove the column "suffix" along with all the columns that have "name".

```{r deaths-select-remove, exercise=T}
deaths

```

<div id="deaths-select-remove-hint">
There are a number of ways you could build this select:

```r
deaths %>% 
  select(-first_name, -middle_name, -last_name, -maiden_name, -suffix)

deaths %>% 
  select(-ends_with("_name"), -suffix)

deaths %>% 
  select(-c(first_name, middle_name, last_name, maiden_name, suffix))
```
</div>


## Filtering data

When you want to capture specific **rows** in your data based on a value in one or more column, you use [`filter()`](https://dplyr.tidyverse.org/reference/filter.html).

Read the code block below and guess what it might do, then run the code chunk. We've also added a `select()` to show a selection of columns.

```{r deaths-filter, exercise=T}
deaths %>% 
  filter(gender == "M") %>% 
  select(ends_with("name"), gender) %>% 
  head()
```

### Filter operators

Note that to match a specific value in the `filter()` argument, you need two equal signs: `==`, and the match has to be in quotes. Here are the other logical tests you can use:

| Operator          | Definition               |
|:------------------:|:-------------------------:|
| x `<` y         | Less than                |
| x `>` y         | Greater than             |
| x `==` y        | Equal to                 |
| x `<=` y        | Less than or equal to    |
| x `>=` y        | Greater than or equal to |
| x `!-` y        | Not equal to             |
| x `%in%` c(y,z) | In a group               |
| `is.na(`x`)`  | Is NA                    |
| `!is.na(`x`)` | Is not NA                |


### Filtering practice

- Write a filter to get only records where the `age_years` is less than 18-years-old and then select only the name and age columns in the result.

```{r try, exercise=T, exercise.line = 8}
deaths
```


<div id="try-hint">
```r
deaths %>% 
  filter(age_years < 18) %>% 
  select(ends_with("_name"), age_years)
```
</div>

### Common mistakes with filter()

#### Use two == signs for “true”

<p style="color:red">Don't do this:</p>

```r
deaths %>% 
  filter(res_county = "CASS")
```

<p style="color:green">Instead do this:</p>

```r
deaths %>% 
  filter(res_county == "CASS")
```

#### Forgetting quotes

<p style="color:red">Don't do this:</p>

```r
deaths %>% 
  filter(county == CASS)
```

<p style="color:green">Instead do this</p>

```r
deaths %>% 
  filter(county == "CASS")
```
  
### Combining filters

You can filter for more than one thing at a time by separating arguments with a comma.

```{r filter-multi, exercise=T, exercise.eval=T, exercise.lines=6}
deaths %>% 
  filter(
    gender == "M",
    manner_death == "ACCIDENT"
  ) %>% 
  select(last_name, gender, manner_death)
```

Note that we broke up the filter into multiple lines to make it easier to read and understand. This is easy to do in RStudio because it helps you indent the lines properly, unlike the learning environment here.

When you use a comma to separate tests, it becomes an AND statement and both tests have to be true. If you want OR, then you use a pipe character `|`. (It's the shift-value of the backslash key on your keyboard, usually above Return. Not-to-be-but-will-be-confused with the tidyverse pipe ` %>% `.)

We put this on one line so you can see both sides of the filter equation together.

```{r filter-or, exercise=T}
deaths %>% 
  filter(manner_death == "HOMICIDE" | manner_death == "PENDING INVESTIGATION") %>% 
  select(manner_death)
```

Note you have to repeat the column name for each test, even if it is another rule on the same column.

We'll show you one more operator called `%in%` because it is particularly useful: Finding rows within a list of values. This gets the same result as the code above, but is easier to write and understand.

```{r filter-in, exercise=T}
deaths %>% 
  filter(manner_death %in% c("HOMICIDE", "PENDING INVESTIGATION")) %>% 
  select(manner_death)
```

Note the use the `c()` construction again to combine several values into a vector to search through. We can even save a vector of items into variable, and then filter with that. Again, this does the same as above, but just extrapolates the list:

```{r filter-list, exercise=T, exercise.eval=T}
manners_list <- c("HOMICIDE", "PENDING INVESTIGATION")

deaths %>% 
  filter(manner_death %in% manners_list)
```

Here are the operators to combine filters:

| Operator | Definition |
|:--------:|:----------:|
|  a `&` b |     and    |
| a `|` b  |     or     |
|   `!`a   |     not    |


### Filter on your own

1. Filter for cases of "African American" women.

```{r filter-aa, exercise = T}
deaths
```

<div id="filter-aa-hint">
```r
deaths %>% 
  filter(
    gender == "F",
    race == "African American"
  )
```
</div>

## Sorting data

The tidyverse verb for sorting data is `arrange()`. We'll introduce it quickly here, but use it more later.

```{r arrange, exercise=T}
deaths %>% 
  arrange(age_years) %>% 
  select(age_years)
```

To get a column to sort in descending order, we use the function `desc()`. There are two ways to go about it"

- Put the column you are sorting within the function: `arrange(desc(age_years))`
- Add the function with a pipe: `arrange(age_years %>% desc())`

```{r arrange-desc, exercise=T}
deaths %>% 
  # arrange descending order using the tidyverse pipe
  arrange(age_years %>% desc()) %>% 
  # select just to see the result.
  select(age_years, manner_death)
```

You can sort by more than one column using a comma between rules within the `arrange()`.

## Practice on your own

Practice using these functions by [solving these quests](https://github.com/utdata/chj-r-introduction/blob/main/students/practice-quests.md) in your practice data.

--- 

We'll stop here for this session. Do the practice!

